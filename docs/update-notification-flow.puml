@startuml Update Notification Flow
!theme plain
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title PWA Update Notification - Sequence Diagram

actor User
participant "Browser" as Browser
participant "+layout.svelte" as Layout
participant "swStore\n(serviceWorker.svelte.ts)" as Store
participant "localStorage" as Storage
participant "UpdateNotification.svelte" as Dialog
participant "Service Worker" as SW

== Page Load / Refresh ==

User -> Browser: Öffnet/Refresht App
activate Browser

Browser -> Layout: onMount()
activate Layout

Layout -> Store: checkForUpdate(APP_VERSION)
activate Store

Store -> Store: notifyUpdate(version)
Store -> Storage: get('carbme_last_seen_version')
activate Storage
Storage --> Store: lastSeenVersion (z.B. "1.1.1")
deactivate Storage

Store -> Store: compareVersions(lastSeen, current)
note right: Vergleicht "1.1.1" mit "1.10.0"

alt Version ist neuer (1.1.1 < 1.10.0)

    alt lastSeen === DEFAULT_VERSION ("1.0.0")
        Store -> Storage: set(version)
        note right: Erste Installation\nKeine Benachrichtigung
    else Echtes Update
        Store -> Store: updateAvailable = true
        Store -> Store: updateInfo = {\n  version,\n  notes,\n  available: true\n}
        note right: State wird reaktiv aktualisiert

        Store --> Dialog: updateAvailable changed
        activate Dialog

        Dialog -> Dialog: $effect triggered
        note right: Svelte reaktive $effect\nerkennt State-Änderung

        Dialog -> Dialog: dialog.showModal()
        Dialog -> User: Zeigt Update-Dialog
        deactivate Dialog
    end

else Version gleich oder älter
    Store -> Store: return (keine Aktion)
end

deactivate Store
deactivate Layout

== Service Worker Registration Path ==

Layout -> Browser: navigator.serviceWorker.register('/sw.js')
Browser -> SW: Registriert Service Worker
activate SW

alt Service Worker bereits waiting
    SW --> Layout: registration.waiting exists
    Layout -> Store: notifyUpdate(APP_VERSION)
    note right: Triggert gleichen Flow wie oben
end

SW -> Layout: registration.addEventListener('updatefound')
note right: Lauscht auf neue SW-Versionen

deactivate SW

== Periodische Prüfung (alle 60 Min) ==

...60 Minuten später...

Layout -> SW: registration.update()
activate SW

alt Neue Version verfügbar
    SW -> SW: Installiert neuen SW
    SW --> Layout: 'updatefound' event
    Layout -> SW: newWorker.addEventListener('statechange')

    SW -> SW: state = 'installed'
    SW --> Layout: statechange event
    Layout -> Store: notifyUpdate(APP_VERSION)
    note right: Triggert Update-Dialog Flow
end

deactivate SW

== User Interaktion mit Dialog ==

User -> Dialog: Klickt "Jetzt aktualisieren"
activate Dialog

Dialog -> Store: markVersionSeen()
activate Store
Store -> Storage: set(APP_VERSION)
note right: Speichert aktuelle Version\num erneute Benachrichtigung\nzu verhindern
deactivate Store

Dialog -> SW: postMessage({type: 'SKIP_WAITING'})
activate SW
SW -> SW: self.skipWaiting()
note right: Aktiviert neuen Service Worker sofort
deactivate SW

Dialog -> Browser: window.location.reload()
Browser -> User: App wird neu geladen
deactivate Dialog

alt User klickt "Später"
    User -> Dialog: Klickt "Später"
    activate Dialog
    Dialog -> Store: dismissUpdate()
    activate Store
    Store -> Store: updateAvailable = false
    Store -> Store: updateInfo = null
    Store -> Storage: set(APP_VERSION)
    deactivate Store
    Dialog -> Dialog: dialog.close()
    deactivate Dialog
end

alt User klickt "Mehr Infos"
    User -> Dialog: Klickt "Mehr Infos"
    Dialog -> Browser: window.open(CHANGELOG_URL)
    Browser -> User: Öffnet Changelog in neuem Tab
end

deactivate Browser

== Koordination: Update Dialog & Onboarding Tour ==

note over User, SW
  Verhindert Modal-Konflikte zwischen Update-Dialog und Onboarding-Tour
  Priorität: Update-Dialog zuerst, dann Onboarding
end note

participant "+page.svelte" as Page
participant "onboardingService" as Onboarding
participant "driver.js" as Driver

...500ms nach Page Load...

Page -> Page: startOnboardingIfNeeded()
activate Page

Page -> Onboarding: shouldShow()
activate Onboarding
Onboarding -> Storage: get('carbme_onboarding')
Storage --> Onboarding: {completed: false, skipped: false}
Onboarding --> Page: true (sollte gezeigt werden)
deactivate Onboarding

Page -> Page: checkAndStart()
note right: Interne Funktion zum\nPrüfen & Starten

Page -> Store: swStore.updateAvailable?
activate Store

alt Update Dialog ist aktiv
    Store --> Page: updateAvailable = true
    deactivate Store

    Page -> Page: console.log('Update notification active, waiting...')
    note right: Onboarding wartet

    ...1 Sekunde später...

    Page -> Page: setTimeout(checkAndStart, 1000)
    note right: Prüft erneut in 1s\n(Polling bis Dialog geschlossen)

    loop Bis Update Dialog geschlossen
        Page -> Store: swStore.updateAvailable?
        Store --> Page: true
        Page -> Page: Warte weitere 1s
    end

else Kein Update Dialog aktiv
    Store --> Page: updateAvailable = false
    deactivate Store

    Page -> Onboarding: startTour(options)
    activate Onboarding

    Onboarding -> Driver: driver({ steps: [...] })
    activate Driver

    Driver -> Driver: drive()
    Driver -> User: Zeigt Onboarding Tour
    note right: 15+ Schritte durch\nalle App-Features
    deactivate Driver

    User -> Onboarding: Tour abgeschlossen/übersprungen

    Onboarding -> Storage: set({completed: true, skipped: false})
    note right: Speichert Status

    deactivate Onboarding
end

deactivate Page

@enduml
